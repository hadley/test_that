#' Locally set options for maximal test reproducibility
#'
#' @description
#' This is run automatically by `test_that()` but you may want to run it
#' yourself if you want to replicate test results interactively. If
#' run inside a function, the effects are automatically reversed when the
#' function exits; if running in the global environment, use
#' [withr::deferred_run()] to undo.
#'
#' It sets the following options with [withr::local_options()]:
#' * `cli.unicode = FALSE` so that the cli package never generates unicode
#'   output (normally cli uses unicode on Linux/Mac but not Windows).
#'   Windows can't easily save unicode output to disk, so it must be set to
#'   false for consistency. (If you need to test unicode output, you'll
#'   also need to skip in non-utf8 locals, e.g. ``skip_if(!l10n_info()$`UTF-8`)``
#' * `crayon.enabled = FALSE` suppresses ANSI colours generated by the crayon
#'   package (normally colours are used if crayon detects that you're in a
#'   terminal that supports colour).
#' * `lifecycle_verbosity = "warning"` so that every lifecycle problem always
#'   generates a warning (otherwise deprecated functions don't generate a
#'   warning every time).
#' * `OutDec = "."` so numbers always uses `.` as the decimal point
#'   (European users sometimes set `OutDec = ","`.)
#' * `rlang_interactive = FALSE` so that [rlang::is_interactive()] returns
#'   `FALSE`, and code that uses it assumes you're in a non-interactive
#'   environment.
#' * `useFancyQuotes = FALSE` so base R functions always use regular (straight)
#'   quotes (otherwise the default is locale dependent, see [sQuote()] for
#'   details).
#' * `width = 80` to control the width of printed output (usually this
#'   varies with the size of your console).
#'
#' It also sets envvars `RSTUDIO = 0` (which ensures that RStudio is never
#' detected as running), and `TESTTHAT = "true"` (which ensures that
#' [is_testing()] returns `TRUE)`, and sets collation locale to "C"
#' (which ensures that character sorting the same regardless of current
#' locale).
#'
#' @export
#' @keywords internal
#' @param .env Environment to use for scoping; expert use only.
local_test_context <- function(.env = parent.frame()) {
  withr::local_envvar(list(TESTTHAT = "true"), .local_envir = .env)
  local_reproducible_output(.env = .env)
}

local_reproducible_output <- function(width = 80,
                                      crayon = FALSE,
                                      unicode = FALSE,
                                      .env = parent.frame()) {

  if (unicode) {
    # If you force unicode display, you _must_ skip the test on non-utf8
    # locales; otherwise it's gauranteed to fail
    skip_if(!l10n_info()$`UTF-8`, "non utf8 locale")
  }

  local_width(width = width, .env = .env)
  withr::local_options(
    list(
      crayon.enabled = crayon,
      cli.unicode = unicode,
      useFancyQuotes = FALSE,
      lifecycle_verbosity = "warning",
      OutDec = ".",
      rlang_interactive = FALSE
    ),
    .local_envir = .env
  )
  withr::local_envvar(c(RSTUDIO = "0"), .local_envir = .env)
  withr::local_collate("C", .local_envir = .env)
}

waldo_compare <- function(x, y, ..., x_arg = "x", y_arg = "y") {

  reporter <- get_reporter()
  if (!is.null(reporter)) {
    # Need to very carefully isolate this change to this function - can not set
    # in expectation functions because part of expectation handling bubbles
    # up through calling handlers, which are run before on.exit()
    reporter$local_user_output()
  }

  waldo::compare(x, y,..., x_arg = x_arg, y_arg = y_arg)
}

local_width <- function(width = 80, .env = parent.frame()) {
  withr::local_options(list(width = width), .local_envir = .env)
  withr::local_envvar(list(RSTUDIO_CONSOLE_WIDTH = width), .local_envir = .env)
}


#' Locally set test directory options
#'
#' For expert use only.
#'
#' @param path Path to directory of files
#' @param package Optional package name, if known.
#' @export
#' @keywords internal
local_test_directory <- function(path, package = NULL, .env = parent.frame()) {
  withr::local_dir(path, .local_envir = .env)
  withr::local_envvar(c(
    R_TESTS = "",
    TESTTHAT = "true",
    TESTTHAT_DIR = path,
    TESTTHAT_PKG = package
  ), .local_envir = .env)
  local_edition(find_edition(path, package), .env = .env)
}
